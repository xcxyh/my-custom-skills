<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¶ è¡—æºœå­çš„è®°å¿†ç©ºé—´</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card-hover {
            transition: all 0.3s ease;
        }

        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .markdown-content h1 { font-size: 1.8rem; font-weight: 700; margin: 1rem 0; color: #e94560; }
        .markdown-content h2 { font-size: 1.5rem; font-weight: 600; margin: 0.8rem 0; color: #f39c12; }
        .markdown-content h3 { font-size: 1.2rem; font-weight: 500; margin: 0.6rem 0; color: #3498db; }
        .markdown-content p { margin: 0.5rem 0; line-height: 1.6; }
        .markdown-content ul, .markdown-content ol { margin: 0.5rem 0; padding-left: 1.5rem; }
        .markdown-content li { margin: 0.3rem 0; }
        .markdown-content code { background: rgba(233, 69, 96, 0.2); padding: 0.2rem 0.4rem; border-radius: 4px; font-size: 0.9em; }
        .markdown-content pre { background: rgba(0, 0, 0, 0.3); padding: 1rem; border-radius: 8px; overflow-x: auto; margin: 1rem 0; }
        .markdown-content pre code { background: none; padding: 0; }
        .markdown-content blockquote { border-left: 4px solid #e94560; padding-left: 1rem; margin: 1rem 0; opacity: 0.8; }
        .markdown-content a { color: #3498db; text-decoration: underline; }
        .markdown-content hr { border: none; border-top: 1px solid rgba(255, 255, 255, 0.1); margin: 1.5rem 0; }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #e94560;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(233, 69, 96, 0.5);
            border-radius: 4px;
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="text-center mb-12">
            <h1 class="text-5xl font-bold mb-4 bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500 bg-clip-text text-transparent">
                ğŸ¶ è¡—æºœå­çš„è®°å¿†ç©ºé—´
            </h1>
            <p class="text-gray-400 text-lg">
                å®æ—¶å¯è§†åŒ– AI åŠ©æ‰‹çš„è®°å¿†ä¸æ€è€ƒ
                <span id="status" class="ml-2 pulse text-green-400">â— å®æ—¶è¿æ¥ä¸­</span>
            </p>
            <button onclick="refreshData()" class="mt-4 px-6 py-2 bg-gradient-to-r from-pink-500 to-purple-500 rounded-full hover:opacity-80 transition-opacity">
                ğŸ”„ åˆ·æ–°æ•°æ®
            </button>
        </header>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="glass rounded-2xl p-6 card-hover">
                <div class="text-3xl mb-2">ğŸ“</div>
                <div class="text-2xl font-bold" id="totalFiles">-</div>
                <div class="text-gray-400 text-sm">è®°å¿†æ–‡ä»¶</div>
            </div>
            <div class="glass rounded-2xl p-6 card-hover">
                <div class="text-3xl mb-2">ğŸ“</div>
                <div class="text-2xl font-bold" id="totalSize">-</div>
                <div class="text-gray-400 text-sm">æ€»å­—æ•°</div>
            </div>
            <div class="glass rounded-2xl p-6 card-hover">
                <div class="text-3xl mb-2">ğŸ•</div>
                <div class="text-2xl font-bold" id="lastUpdate">-</div>
                <div class="text-gray-400 text-sm">æœ€åæ›´æ–°</div>
            </div>
            <div class="glass rounded-2xl p-6 card-hover">
                <div class="text-3xl mb-2">ğŸ’¾</div>
                <div class="text-2xl font-bold" id="memorySize">-</div>
                <div class="text-gray-400 text-sm">è®°å¿†å¤§å°</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- File List -->
            <div class="lg:col-span-1">
                <div class="glass rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">ğŸ“š</span> è®°å¿†æ–‡ä»¶
                    </h2>
                    <div id="fileList" class="space-y-3">
                        <div class="text-center py-8">
                            <div class="loading mx-auto mb-2"></div>
                            <p class="text-gray-400">åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Content Viewer -->
            <div class="lg:col-span-2">
                <div class="glass rounded-2xl p-6 min-h-[600px]">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <span class="mr-2">ğŸ‘ï¸</span> å†…å®¹é¢„è§ˆ
                    </h2>
                    <div id="contentViewer" class="markdown-content">
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">ğŸ‘†</div>
                            <p class="text-gray-400">ç‚¹å‡»å·¦ä¾§æ–‡ä»¶æŸ¥çœ‹å†…å®¹</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Powered by Clawdbot Â· Made with â¤ï¸ by xiong</p>
        </footer>
    </div>

    <script>
        // æ£€æµ‹æ˜¯å¦åœ¨æ’ä»¶ç¯å¢ƒä¸­è¿è¡Œ
        const isPluginEnv = window.location.port === '18789';
        const API_BASE = isPluginEnv ? 'http://localhost:3001' : window.location.origin;

        let currentFiles = [];
        let autoRefreshInterval = null;

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'åˆšåˆš';
            if (minutes < 60) return `${minutes} åˆ†é’Ÿå‰`;
            if (hours < 24) return `${hours} å°æ—¶å‰`;
            return `${days} å¤©å‰`;
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(filename) {
            if (filename.includes('MEMORY')) return 'ğŸ§ ';
            if (filename.includes('heartbeat')) return 'ğŸ’“';
            if (filename.includes('moltbook')) return 'ğŸŒ';
            if (filename.includes('learning')) return 'ğŸ“–';
            if (filename.includes('conversation')) return 'ğŸ’¬';
            if (filename.endsWith('.json')) return 'ğŸ“Š';
            return 'ğŸ“„';
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const response = await fetch(`${API_BASE}/api/memory`);
                const data = await response.json();

                if (data.success) {
                    currentFiles = data.files;
                    updateStats(data.files);
                    renderFileList(data.files);
                    document.getElementById('status').innerHTML = 'â— å·²è¿æ¥';
                    document.getElementById('status').className = 'ml-2 text-green-400';
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('status').innerHTML = 'â— è¿æ¥å¤±è´¥';
                document.getElementById('status').className = 'ml-2 text-red-400 pulse';
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(files) {
            const totalFiles = files.length;
            const totalSize = files.reduce((sum, f) => sum + f.content.length, 0);
            const lastUpdate = files.length > 0 ? files[0].modified : null;
            const memoryBytes = files.reduce((sum, f) => sum + f.size, 0);

            document.getElementById('totalFiles').textContent = totalFiles;
            document.getElementById('totalSize').textContent = totalSize.toLocaleString();
            document.getElementById('memorySize').textContent = formatSize(memoryBytes);

            if (lastUpdate) {
                document.getElementById('lastUpdate').textContent = formatTime(new Date(lastUpdate));
            }
        }

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFileList(files) {
            const container = document.getElementById('fileList');

            if (files.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-8">æš‚æ— è®°å¿†æ–‡ä»¶</p>';
                return;
            }

            container.innerHTML = files.map((file, index) => `
                <div class="file-item bg-white/5 rounded-xl p-4 cursor-pointer hover:bg-white/10 transition-all border border-transparent hover:border-pink-500/50"
                     onclick="viewFile('${file.name}')">
                    <div class="flex items-start justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${getFileIcon(file.name)}</span>
                            <div>
                                <div class="font-medium">${file.name}</div>
                                <div class="text-xs text-gray-400">
                                    ${formatSize(file.size)} Â· ${formatTime(new Date(file.modified))}
                                </div>
                            </div>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full ${
                            file.type === 'json' ? 'bg-blue-500/20 text-blue-400' : 'bg-purple-500/20 text-purple-400'
                        }">
                            ${file.type}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        // æŸ¥çœ‹æ–‡ä»¶å†…å®¹
        async function viewFile(filename) {
            const viewer = document.getElementById('contentViewer');
            viewer.innerHTML = '<div class="text-center py-12"><div class="loading mx-auto mb-4"></div><p class="text-gray-400">åŠ è½½ä¸­...</p></div>';

            try {
                let data;
                if (filename === 'MEMORY.md') {
                    const response = await fetch(`${API_BASE}/api/memory-main`);
                    data = await response.json();
                } else {
                    const response = await fetch(`${API_BASE}/api/memory/${filename}`);
                    data = await response.json();
                }

                if (data.success) {
                    const file = data.file;
                    let content;

                    if (file.type === 'json') {
                        try {
                            const json = JSON.parse(file.content);
                            content = `<pre><code class="language-json">${JSON.stringify(json, null, 2)}</code></pre>`;
                        } catch (e) {
                            content = `<pre><code>${file.content}</code></pre>`;
                        }
                    } else {
                        content = marked.parse(file.content);
                    }

                    viewer.innerHTML = `
                        <div class="mb-4 flex items-center justify-between">
                            <div class="flex items-center space-x-2">
                                <span class="text-2xl">${getFileIcon(file.name)}</span>
                                <span class="font-bold text-lg">${file.name}</span>
                            </div>
                            <span class="text-sm text-gray-400">
                                ${formatSize(file.size)} Â· ${new Date(file.modified).toLocaleString('zh-CN')}
                            </span>
                        </div>
                        <hr class="border-white/10">
                        <div class="mt-4">${content}</div>
                    `;
                }
            } catch (error) {
                console.error('Error viewing file:', error);
                viewer.innerHTML = '<div class="text-center py-12 text-red-400">åŠ è½½å¤±è´¥ ğŸ˜¢</div>';
            }
        }

        // åˆ·æ–°æ•°æ®
        function refreshData() {
            loadData();
        }

        // åˆå§‹åŒ–
        loadData();

        // è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
        setInterval(loadData, 30000);
    </script>
</body>
</html>
